{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../../src/scraper/scrapeURL/engines/index.ts"],"names":[],"mappings":"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","sourcesContent":["import { ScrapeActionContent } from \"../../../lib/entities\";\nimport { Meta } from \"..\";\nimport { scrapeDOCX } from \"./docx\";\nimport { scrapeURLWithFireEngineChromeCDP, scrapeURLWithFireEnginePlaywright, scrapeURLWithFireEngineTLSClient } from \"./fire-engine\";\nimport { scrapePDF } from \"./pdf\";\nimport { scrapeURLWithScrapingBee } from \"./scrapingbee\";\nimport { scrapeURLWithFetch } from \"./fetch\";\nimport { scrapeURLWithPlaywright } from \"./playwright\";\nimport { scrapeCache } from \"./cache\";\n\nexport type Engine = \"fire-engine;chrome-cdp\" | \"fire-engine;playwright\" | \"fire-engine;tlsclient\" | \"scrapingbee\" | \"scrapingbeeLoad\" | \"playwright\" | \"fetch\" | \"pdf\" | \"docx\" | \"cache\";\n\nconst useScrapingBee = process.env.SCRAPING_BEE_API_KEY !== '' && process.env.SCRAPING_BEE_API_KEY !== undefined;\nconst useFireEngine = process.env.FIRE_ENGINE_BETA_URL !== '' && process.env.FIRE_ENGINE_BETA_URL !== undefined;\nconst usePlaywright = process.env.PLAYWRIGHT_MICROSERVICE_URL !== '' && process.env.PLAYWRIGHT_MICROSERVICE_URL !== undefined;\nconst useCache = process.env.CACHE_REDIS_URL !== '' && process.env.CACHE_REDIS_URL !== undefined;\n\nexport const engines: Engine[] = [\n    // ...(useCache ? [ \"cache\" as const ] : []),\n    ...(useFireEngine ? [ \"fire-engine;chrome-cdp\" as const, \"fire-engine;playwright\" as const, \"fire-engine;tlsclient\" as const ] : []),\n    ...(useScrapingBee ? [ \"scrapingbee\" as const, \"scrapingbeeLoad\" as const ] : []),\n    ...(usePlaywright ? [ \"playwright\" as const ] : []),\n    \"fetch\",\n    \"pdf\",\n    \"docx\",\n];\n\nexport const featureFlags = [\n    \"actions\",\n    \"waitFor\",\n    \"screenshot\",\n    \"screenshot@fullScreen\",\n    \"pdf\",\n    \"docx\",\n    \"atsv\",\n    \"location\",\n    \"mobile\",\n    \"skipTlsVerification\",\n    \"useFastMode\",\n] as const;\n\nexport type FeatureFlag = typeof featureFlags[number];\n\nexport const featureFlagOptions: {\n    [F in FeatureFlag]: {\n        priority: number;\n    }\n} = {\n    \"actions\": { priority: 20 },\n    \"waitFor\": { priority: 1 },\n    \"screenshot\": { priority: 10 },\n    \"screenshot@fullScreen\": { priority: 10 },\n    \"pdf\": { priority: 100 },\n    \"docx\": { priority: 100 },\n    \"atsv\": { priority: 90 }, // NOTE: should atsv force to tlsclient? adjust priority if not\n    \"useFastMode\": { priority: 90 },\n    \"location\": { priority: 10 },\n    \"mobile\": { priority: 10 },\n    \"skipTlsVerification\": { priority: 10 },\n} as const;\n\nexport type EngineScrapeResult = {\n    url: string;\n\n    html: string;\n    markdown?: string;\n    statusCode: number;\n    error?: string;\n\n    screenshot?: string;\n    actions?: {\n        screenshots: string[];\n        scrapes: ScrapeActionContent[];\n    };\n}\n\nconst engineHandlers: {\n    [E in Engine]: (meta: Meta) => Promise<EngineScrapeResult>\n} = {\n    \"cache\": scrapeCache,\n    \"fire-engine;chrome-cdp\": scrapeURLWithFireEngineChromeCDP,\n    \"fire-engine;playwright\": scrapeURLWithFireEnginePlaywright,\n    \"fire-engine;tlsclient\": scrapeURLWithFireEngineTLSClient,\n    \"scrapingbee\": scrapeURLWithScrapingBee(\"domcontentloaded\"),\n    \"scrapingbeeLoad\": scrapeURLWithScrapingBee(\"networkidle2\"),\n    \"playwright\": scrapeURLWithPlaywright,\n    \"fetch\": scrapeURLWithFetch,\n    \"pdf\": scrapePDF,\n    \"docx\": scrapeDOCX,\n};\n\nexport const engineOptions: {\n    [E in Engine]: {\n        // A list of feature flags the engine supports.\n        features: { [F in FeatureFlag]: boolean },\n\n        // This defines the order of engines in general. The engine with the highest quality will be used the most.\n        // Negative quality numbers are reserved for specialty engines, e.g. PDF and DOCX\n        quality: number,\n    }\n} = {\n    \"cache\": {\n        features: {\n            \"actions\": false,\n            \"waitFor\": true,\n            \"screenshot\": false,\n            \"screenshot@fullScreen\": false,\n            \"pdf\": false, // TODO: figure this out\n            \"docx\": false, // TODO: figure this out\n            \"atsv\": false,\n            \"location\": false,\n            \"mobile\": false,\n            \"skipTlsVerification\": false,\n            \"useFastMode\": false,\n        },\n        quality: 1000, // cache should always be tried first\n    },\n    \"fire-engine;chrome-cdp\": {\n        features: {\n            \"actions\": true,\n            \"waitFor\": true, // through actions transform\n            \"screenshot\": true, // through actions transform\n            \"screenshot@fullScreen\": true, // through actions transform\n            \"pdf\": false,\n            \"docx\": false,\n            \"atsv\": false,\n            \"location\": true,\n            \"mobile\": true,\n            \"skipTlsVerification\": true,\n            \"useFastMode\": false,\n        },\n        quality: 50,\n    },\n    \"fire-engine;playwright\": {\n        features: {\n            \"actions\": false,\n            \"waitFor\": true,\n            \"screenshot\": true,\n            \"screenshot@fullScreen\": true,\n            \"pdf\": false,\n            \"docx\": false,\n            \"atsv\": false,\n            \"location\": false,\n            \"mobile\": false,\n            \"skipTlsVerification\": false,\n            \"useFastMode\": false,\n        },\n        quality: 40,\n    },\n    \"scrapingbee\": {\n        features: {\n            \"actions\": false,\n            \"waitFor\": true,\n            \"screenshot\": true,\n            \"screenshot@fullScreen\": true,\n            \"pdf\": false,\n            \"docx\": false,\n            \"atsv\": false,\n            \"location\": false,\n            \"mobile\": false,\n            \"skipTlsVerification\": false,\n            \"useFastMode\": false,\n        },\n        quality: 30,\n    },\n    \"scrapingbeeLoad\": {\n        features: {\n            \"actions\": false,\n            \"waitFor\": true,\n            \"screenshot\": true,\n            \"screenshot@fullScreen\": true,\n            \"pdf\": false,\n            \"docx\": false,\n            \"atsv\": false,\n            \"location\": false,\n            \"mobile\": false,\n            \"skipTlsVerification\": false,\n            \"useFastMode\": false,\n        },\n        quality: 29,\n    },\n    \"playwright\": {\n        features: {\n            \"actions\": false,\n            \"waitFor\": true,\n            \"screenshot\": false,\n            \"screenshot@fullScreen\": false,\n            \"pdf\": false,\n            \"docx\": false,\n            \"atsv\": false,\n            \"location\": false,\n            \"mobile\": false,\n            \"skipTlsVerification\": false,\n            \"useFastMode\": false,\n        },\n        quality: 20,\n    },\n    \"fire-engine;tlsclient\": {\n        features: {\n            \"actions\": false,\n            \"waitFor\": false,\n            \"screenshot\": false,\n            \"screenshot@fullScreen\": false,\n            \"pdf\": false,\n            \"docx\": false,\n            \"atsv\": true,\n            \"location\": true,\n            \"mobile\": false,\n            \"skipTlsVerification\": false,\n            \"useFastMode\": true,\n        },\n        quality: 10,\n    },\n    \"fetch\": {\n        features: {\n            \"actions\": false,\n            \"waitFor\": false,\n            \"screenshot\": false,\n            \"screenshot@fullScreen\": false,\n            \"pdf\": false,\n            \"docx\": false,\n            \"atsv\": false,\n            \"location\": false,\n            \"mobile\": false,\n            \"skipTlsVerification\": false,\n            \"useFastMode\": true,\n        },\n        quality: 5,\n    },\n    \"pdf\": {\n        features: {\n            \"actions\": false,\n            \"waitFor\": false,\n            \"screenshot\": false,\n            \"screenshot@fullScreen\": false,\n            \"pdf\": true,\n            \"docx\": false,\n            \"atsv\": false,\n            \"location\": false,\n            \"mobile\": false,\n            \"skipTlsVerification\": false,\n            \"useFastMode\": true,\n        },\n        quality: -10,\n    },\n    \"docx\": {\n        features: {\n            \"actions\": false,\n            \"waitFor\": false,\n            \"screenshot\": false,\n            \"screenshot@fullScreen\": false,\n            \"pdf\": false,\n            \"docx\": true,\n            \"atsv\": false,\n            \"location\": false,\n            \"mobile\": false,\n            \"skipTlsVerification\": false,\n            \"useFastMode\": true,\n        },\n        quality: -10,\n    },\n};\n\nexport function buildFallbackList(meta: Meta): {\n    engine: Engine,\n    unsupportedFeatures: Set<FeatureFlag>,\n}[] {\n    const prioritySum = [...meta.featureFlags].reduce((a, x) => a + featureFlagOptions[x].priority, 0);\n    const priorityThreshold = Math.floor(prioritySum / 2);\n    let selectedEngines: {\n        engine: Engine,\n        supportScore: number,\n        unsupportedFeatures: Set<FeatureFlag>,\n    }[] = [];\n\n    const currentEngines = meta.internalOptions.forceEngine !== undefined ? [meta.internalOptions.forceEngine] : engines;\n\n    for (const engine of currentEngines) {\n        const supportedFlags = new Set([...Object.entries(engineOptions[engine].features).filter(([k, v]) => meta.featureFlags.has(k as FeatureFlag) && v === true).map(([k, _]) => k)]);\n        const supportScore = [...supportedFlags].reduce((a, x) => a + featureFlagOptions[x].priority, 0);\n\n        const unsupportedFeatures = new Set([...meta.featureFlags]);\n            for (const flag of meta.featureFlags) {\n                if (supportedFlags.has(flag)) {\n                    unsupportedFeatures.delete(flag);\n                }\n            }\n\n        if (supportScore >= priorityThreshold) {\n            selectedEngines.push({ engine, supportScore, unsupportedFeatures });\n            meta.logger.debug(`Engine ${engine} meets feature priority threshold`, { supportScore, prioritySum, priorityThreshold, featureFlags: [...meta.featureFlags], unsupportedFeatures });\n        } else {\n            meta.logger.debug(`Engine ${engine} does not meet feature priority threshold`, { supportScore, prioritySum, priorityThreshold, featureFlags: [...meta.featureFlags], unsupportedFeatures});\n        }\n    }\n\n    if (selectedEngines.some(x => engineOptions[x.engine].quality > 0)) {\n        selectedEngines = selectedEngines.filter(x => engineOptions[x.engine].quality > 0);\n    }\n\n    selectedEngines.sort((a,b) => b.supportScore - a.supportScore || engineOptions[b.engine].quality - engineOptions[a.engine].quality);\n\n    return selectedEngines;\n}\n\nexport async function scrapeURLWithEngine(meta: Meta, engine: Engine): Promise<EngineScrapeResult> {\n    const fn = engineHandlers[engine];\n    const logger = meta.logger.child({ method: fn.name ?? \"scrapeURLWithEngine\", engine });\n    const _meta = {\n        ...meta,\n        logger,\n    };\n\n    return await fn(_meta);\n}\n"]}
{"version":3,"file":"rate-limiter.js","sourceRoot":"","sources":["../../../src/services/rate-limiter.ts"],"names":[],"mappings":"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","sourcesContent":["import { RateLimiterRedis } from \"rate-limiter-flexible\";\nimport { RateLimiterMode } from \"../../src/types\";\nimport Redis from \"ioredis\";\n\nconst RATE_LIMITS = {\n  crawl: {\n    default: 3,\n    free: 2,\n    starter: 10,\n    standard: 5,\n    standardOld: 40,\n    scale: 50,\n    hobby: 3,\n    standardNew: 10,\n    standardnew: 10,\n    growth: 50,\n    growthdouble: 50,\n    etier2c: 300,\n    etier1a: 1000,\n    etier2a: 300,\n  },\n  scrape: {\n    default: 20,\n    free: 10,\n    starter: 100,\n    standard: 100,\n    standardOld: 100,\n    scale: 500,\n    hobby: 20,\n    standardNew: 100,\n    standardnew: 100,\n    growth: 1000,\n    growthdouble: 1000,\n    etier2c: 2500,\n    etier1a: 1000,\n    etier2a: 2500,\n  },\n  search: {\n    default: 20,\n    free: 5,\n    starter: 50,\n    standard: 50,\n    standardOld: 40,\n    scale: 500,\n    hobby: 10,\n    standardNew: 50,\n    standardnew: 50,\n    growth: 500,\n    growthdouble: 500,\n    etier2c: 2500,\n    etier1a: 1000,\n    etier2a: 2500,\n  },\n  map:{\n    default: 20,\n    free: 5,\n    starter: 50,\n    standard: 50,\n    standardOld: 50,\n    scale: 500,\n    hobby: 10,\n    standardNew: 50,\n    standardnew: 50,\n    growth: 500,\n    growthdouble: 500,\n    etier2c: 2500,\n    etier1a: 1000,\n    etier2a: 2500,\n  },\n  preview: {\n    free: 5,\n    default: 5,\n  },\n  account: {\n    free: 100,\n    default: 100,\n  },\n  crawlStatus: {\n    free: 300,\n    default: 500,\n  },\n  testSuite: {\n    free: 10000,\n    default: 10000,\n  },\n};\n\nexport const redisRateLimitClient = new Redis(\n  process.env.REDIS_RATE_LIMIT_URL!\n)\n\nconst createRateLimiter = (keyPrefix, points) =>\n  new RateLimiterRedis({\n    storeClient: redisRateLimitClient,\n    keyPrefix,\n    points,\n    duration: 60, // Duration in seconds\n  });\n\nexport const serverRateLimiter = createRateLimiter(\n  \"server\",\n  RATE_LIMITS.account.default\n);\n\nexport const testSuiteRateLimiter = new RateLimiterRedis({\n  storeClient: redisRateLimitClient,\n  keyPrefix: \"test-suite\",\n  points: 10000,\n  duration: 60, // Duration in seconds\n});\n\nexport const devBRateLimiter = new RateLimiterRedis({\n  storeClient: redisRateLimitClient,\n  keyPrefix: \"dev-b\",\n  points: 1200,\n  duration: 60, // Duration in seconds\n});\n\nexport const manualRateLimiter = new RateLimiterRedis({\n  storeClient: redisRateLimitClient,\n  keyPrefix: \"manual\",\n  points: 2000,\n  duration: 60, // Duration in seconds\n});\n\n\nexport const scrapeStatusRateLimiter = new RateLimiterRedis({\n  storeClient: redisRateLimitClient,\n  keyPrefix: \"scrape-status\",\n  points: 400,\n  duration: 60, // Duration in seconds\n});\n\nexport const etier1aRateLimiter = new RateLimiterRedis({\n  storeClient: redisRateLimitClient,\n  keyPrefix: \"etier1a\",\n  points: 10000,\n  duration: 60, // Duration in seconds\n});\n\nexport const etier2aRateLimiter = new RateLimiterRedis({\n  storeClient: redisRateLimitClient,\n  keyPrefix: \"etier2a\",\n  points: 2500,\n  duration: 60, // Duration in seconds\n});\n\nconst testSuiteTokens = [\n  \"a01ccae\",\n  \"6254cf9\",\n  \"0f96e673\",\n  \"23befa1b\",\n  \"69141c4\",\n  \"48f9a97\",\n  \"5dc70ad\",\n  \"e5e60e5\",\n  \"65181ba\",\n  \"77c85b7\",\n  \"8567275\",\n  \"6c46abb\",\n  \"cb0ff78\",\n  \"fd769b2\",\n  \"4c2638d\",\n  \"cbb3462\", // don't remove (s-ai)\n  \"824abcd\" // don't remove (s-ai)\n];\n\nconst manual = [\"69be9e74-7624-4990-b20d-08e0acc70cf6\"];\n\nfunction makePlanKey(plan?: string) {\n  return plan ? plan.replace(\"-\", \"\") : \"default\"; // \"default\"\n}\n\nexport function getRateLimiterPoints(\n  mode: RateLimiterMode,\n  token?: string,\n  plan?: string,\n  teamId?: string\n) : number {\n  const rateLimitConfig = RATE_LIMITS[mode]; // {default : 5}\n\n  if (!rateLimitConfig) return RATE_LIMITS.account.default;\n  \n  const points : number =\n    rateLimitConfig[makePlanKey(plan)] || rateLimitConfig.default; // 5\n  return points;\n}\n\nexport function getRateLimiter(\n  mode: RateLimiterMode,\n  token?: string,\n  plan?: string,\n  teamId?: string\n ) : RateLimiterRedis {\n  if (token && testSuiteTokens.some(testToken => token.includes(testToken))) {\n    return testSuiteRateLimiter;\n  }\n\n  if(teamId && teamId === process.env.DEV_B_TEAM_ID) {\n    return devBRateLimiter;\n  }\n  \n  if(teamId && teamId === process.env.ETIER1A_TEAM_ID) {\n    return etier1aRateLimiter;\n  }\n\n  if(teamId && teamId === process.env.ETIER2A_TEAM_ID) {\n    return etier2aRateLimiter;\n  }\n\n  if(teamId && teamId === process.env.ETIER2D_TEAM_ID) {\n    return etier2aRateLimiter;\n  }\n\n  if(teamId && manual.includes(teamId)) {\n    return manualRateLimiter;\n  }\n  \n  return createRateLimiter(`${mode}-${makePlanKey(plan)}`, getRateLimiterPoints(mode, token, plan, teamId));\n}\n"]}
{"version":3,"file":"webhook.js","sourceRoot":"","sources":["../../../src/services/webhook.ts"],"names":[],"mappings":";;;;;;AAAA,kDAA0B;AAC1B,0CAAuC;AACvC,yCAA8C;AAE9C,mCAAsC;AAEtC,mDAAwD;AACxD,IAAA,qBAAY,GAAE,CAAC;AAER,MAAM,WAAW,GAAG,KAAK,EAC9B,MAAc,EACd,EAAU,EACV,IAAgB,EAChB,SAAyC,EACzC,EAAE,GAAG,KAAK,EACV,YAA8B,YAAY,EAC1C,eAAwB,KAAK,EAC7B,EAAE;IACF,IAAI,CAAC;QACH,MAAM,aAAa,GAAG,OAAO,CAAC,GAAG,CAAC,uBAAuB,EAAE,OAAO,CAChE,YAAY,EACZ,EAAE,CACH,CAAC;QACF,MAAM,mBAAmB,GAAG,OAAO,CAAC,GAAG,CAAC,qBAAqB,KAAK,MAAM,CAAC;QACzE,IAAI,UAAU,GAAG,SAAS,IAAI,CAAC,aAAa,CAAC,CAAC,CAAC,qBAAa,CAAC,KAAK,CAAC,EAAE,GAAG,EAAE,aAAa,EAAE,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC;QAExG,gHAAgH;QAChH,oEAAoE;QACpE,IAAI,CAAC,UAAU,IAAI,mBAAmB,EAAE,CAAC;YACvC,MAAM,EAAE,IAAI,EAAE,YAAY,EAAE,KAAK,EAAE,GAAG,MAAM,2BAAgB;iBACzD,IAAI,CAAC,UAAU,CAAC;iBAChB,MAAM,CAAC,KAAK,CAAC;iBACb,EAAE,CAAC,SAAS,EAAE,MAAM,CAAC;iBACrB,KAAK,CAAC,CAAC,CAAC,CAAC;YACZ,IAAI,KAAK,EAAE,CAAC;gBACV,eAAM,CAAC,KAAK,CACV,2CAA2C,MAAM,YAAY,KAAK,CAAC,OAAO,EAAE,CAC7E,CAAC;gBACF,OAAO,IAAI,CAAC;YACd,CAAC;YAED,IAAI,CAAC,YAAY,IAAI,YAAY,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;gBAC/C,OAAO,IAAI,CAAC;YACd,CAAC;YAED,UAAU,GAAG,YAAY,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC;QACnC,CAAC;QAED,eAAM,CAAC,KAAK,CAAC,oBAAoB,EAAE,EAAE,UAAU,EAAE,MAAM,EAAE,SAAS,EAAE,EAAE,EAAE,SAAS,EAAE,YAAY,EAAE,CAAC,CAAC;QAEnG,IAAI,CAAC,UAAU,EAAE,CAAC;YAChB,OAAO,IAAI,CAAC;QACd,CAAC;QAED,IAAI,UAAU,GAAU,EAAE,CAAC;QAC3B,IACE,IAAI;YACJ,IAAI,CAAC,MAAM;YACX,IAAI,CAAC,MAAM,CAAC,KAAK;YACjB,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,MAAM,KAAK,CAAC,EAC9B,CAAC;YACD,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE,CAAC;gBAClD,IAAI,EAAE,EAAE,CAAC;oBACP,UAAU,CAAC,IAAI,CACb,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,OAAO,CAC7B,CAAC;gBACJ,CAAC;qBAAM,CAAC;oBACN,UAAU,CAAC,IAAI,CAAC;wBACd,OAAO,EAAE,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,OAAO;wBAC7C,QAAQ,EAAE,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,QAAQ;wBAC/C,QAAQ,EAAE,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,QAAQ;qBAChD,CAAC,CAAC;gBACL,CAAC;YACH,CAAC;QACH,CAAC;QAED,IAAI,YAAY,EAAE,CAAC;YACjB,IAAI,CAAC;gBACH,MAAM,eAAK,CAAC,IAAI,CACd,UAAU,CAAC,GAAG,EACd;oBACE,OAAO,EAAE,CAAC,EAAE;wBACV,CAAC,CAAC,IAAI,CAAC,OAAO;wBACd,CAAC,CAAC,SAAS,KAAK,YAAY;4BAC5B,CAAC,CAAC,IAAI,CAAC,OAAO;4BACd,CAAC,CAAC,IAAI;oBACR,IAAI,EAAE,SAAS;oBACf,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,OAAO,CAAC,EAAE,EAAE;oBACzB,IAAI,EAAE,UAAU;oBAChB,KAAK,EAAE,CAAC,EAAE;wBACR,CAAC,CAAC,IAAI,EAAE,KAAK,IAAI,SAAS;wBAC1B,CAAC,CAAC,SAAS,KAAK,YAAY;4BAC5B,CAAC,CAAC,IAAI,EAAE,KAAK,IAAI,SAAS;4BAC1B,CAAC,CAAC,SAAS;iBACd,EACD;oBACE,OAAO,EAAE;wBACP,cAAc,EAAE,kBAAkB;wBAClC,GAAG,UAAU,CAAC,OAAO;qBACtB;oBACD,OAAO,EAAE,EAAE,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,KAAK,EAAE,0BAA0B;iBACxD,CACF,CAAC;YACJ,CAAC;YAAC,OAAO,KAAK,EAAE,CAAC;gBACf,eAAM,CAAC,KAAK,CACV,gDAAgD,MAAM,YAAY,KAAK,CAAC,OAAO,EAAE,CAClF,CAAC;YACJ,CAAC;QACH,CAAC;aAAM,CAAC;YACN,eAAK;iBACF,IAAI,CACH,UAAU,CAAC,GAAG,EACd;gBACE,OAAO,EAAE,CAAC,EAAE;oBACV,CAAC,CAAC,IAAI,CAAC,OAAO;oBACd,CAAC,CAAC,SAAS,KAAK,YAAY;wBAC5B,CAAC,CAAC,IAAI,CAAC,OAAO;wBACd,CAAC,CAAC,IAAI;gBACR,IAAI,EAAE,SAAS;gBACf,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,OAAO,CAAC,EAAE,EAAE;gBACzB,IAAI,EAAE,UAAU;gBAChB,KAAK,EAAE,CAAC,EAAE;oBACR,CAAC,CAAC,IAAI,EAAE,KAAK,IAAI,SAAS;oBAC1B,CAAC,CAAC,SAAS,KAAK,YAAY;wBAC5B,CAAC,CAAC,IAAI,EAAE,KAAK,IAAI,SAAS;wBAC1B,CAAC,CAAC,SAAS;aACd,EACD;gBACE,OAAO,EAAE;oBACP,cAAc,EAAE,kBAAkB;oBAClC,GAAG,UAAU,CAAC,OAAO;iBACtB;aACF,CACF;iBACA,KAAK,CAAC,CAAC,KAAK,EAAE,EAAE;gBACf,eAAM,CAAC,KAAK,CACV,4CAA4C,MAAM,YAAY,KAAK,CAAC,OAAO,EAAE,CAC9E,CAAC;YACJ,CAAC,CAAC,CAAC;QACP,CAAC;IACH,CAAC;IAAC,OAAO,KAAK,EAAE,CAAC;QACf,eAAM,CAAC,KAAK,CACV,sCAAsC,MAAM,YAAY,KAAK,CAAC,OAAO,EAAE,CACxE,CAAC;IACJ,CAAC;AACH,CAAC,CAAC;AAxIW,QAAA,WAAW,eAwItB","sourcesContent":["import axios from \"axios\";\nimport { logger } from \"../lib/logger\";\nimport { supabase_service } from \"./supabase\";\nimport { WebhookEventType } from \"../types\";\nimport { configDotenv } from \"dotenv\";\nimport { z } from \"zod\";\nimport { webhookSchema } from \"../controllers/v1/types\";\nconfigDotenv();\n\nexport const callWebhook = async (\n  teamId: string,\n  id: string,\n  data: any | null,\n  specified?: z.infer<typeof webhookSchema>,\n  v1 = false,\n  eventType: WebhookEventType = \"crawl.page\",\n  awaitWebhook: boolean = false\n) => {\n  try {\n    const selfHostedUrl = process.env.SELF_HOSTED_WEBHOOK_URL?.replace(\n      \"{{JOB_ID}}\",\n      id\n    );\n    const useDbAuthentication = process.env.USE_DB_AUTHENTICATION === \"true\";\n    let webhookUrl = specified ?? (selfHostedUrl ? webhookSchema.parse({ url: selfHostedUrl }) : undefined);\n\n    // Only fetch the webhook URL from the database if the self-hosted webhook URL and specified webhook are not set\n    // and the USE_DB_AUTHENTICATION environment variable is set to true\n    if (!webhookUrl && useDbAuthentication) {\n      const { data: webhooksData, error } = await supabase_service\n        .from(\"webhooks\")\n        .select(\"url\")\n        .eq(\"team_id\", teamId)\n        .limit(1);\n      if (error) {\n        logger.error(\n          `Error fetching webhook URL for team ID: ${teamId}, error: ${error.message}`\n        );\n        return null;\n      }\n\n      if (!webhooksData || webhooksData.length === 0) {\n        return null;\n      }\n\n      webhookUrl = webhooksData[0].url;\n    }\n\n    logger.debug(\"Calling webhook...\", { webhookUrl, teamId, specified, v1, eventType, awaitWebhook });\n\n    if (!webhookUrl) {\n      return null;\n    }\n\n    let dataToSend: any[] = [];\n    if (\n      data &&\n      data.result &&\n      data.result.links &&\n      data.result.links.length !== 0\n    ) {\n      for (let i = 0; i < data.result.links.length; i++) {\n        if (v1) {\n          dataToSend.push(\n            data.result.links[i].content\n          );\n        } else {\n          dataToSend.push({\n            content: data.result.links[i].content.content,\n            markdown: data.result.links[i].content.markdown,\n            metadata: data.result.links[i].content.metadata,\n          });\n        }\n      }\n    }\n\n    if (awaitWebhook) {\n      try {\n        await axios.post(\n          webhookUrl.url,\n          {\n            success: !v1\n              ? data.success\n              : eventType === \"crawl.page\"\n              ? data.success\n              : true,\n            type: eventType,\n            [v1 ? \"id\" : \"jobId\"]: id,\n            data: dataToSend,\n            error: !v1\n              ? data?.error || undefined\n              : eventType === \"crawl.page\"\n              ? data?.error || undefined\n              : undefined,\n          },\n          {\n            headers: {\n              \"Content-Type\": \"application/json\",\n              ...webhookUrl.headers,\n            },\n            timeout: v1 ? 10000 : 30000, // 10 seconds timeout (v1)\n          }\n        );\n      } catch (error) {\n        logger.error(\n          `Axios error (0) sending webhook for team ID: ${teamId}, error: ${error.message}`\n        );\n      }\n    } else {\n      axios\n        .post(\n          webhookUrl.url,\n          {\n            success: !v1\n              ? data.success\n              : eventType === \"crawl.page\"\n              ? data.success\n              : true,\n            type: eventType,\n            [v1 ? \"id\" : \"jobId\"]: id,\n            data: dataToSend,\n            error: !v1\n              ? data?.error || undefined\n              : eventType === \"crawl.page\"\n              ? data?.error || undefined\n              : undefined,\n          },\n          {\n            headers: {\n              \"Content-Type\": \"application/json\",\n              ...webhookUrl.headers,\n            },\n          }\n        )\n        .catch((error) => {\n          logger.error(\n            `Axios error sending webhook for team ID: ${teamId}, error: ${error.message}`\n          );\n        });\n    }\n  } catch (error) {\n    logger.debug(\n      `Error sending webhook for team ID: ${teamId}, error: ${error.message}`\n    );\n  }\n};\n"]}
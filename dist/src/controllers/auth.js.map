{"version":3,"file":"auth.js","sourceRoot":"","sources":["../../../src/controllers/auth.ts"],"names":[],"mappings":"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","sourcesContent":["import { parseApi } from \"../lib/parseApi\";\nimport { getRateLimiter } from \"../services/rate-limiter\";\nimport {\n  AuthResponse,\n  NotificationType,\n  PlanType,\n  RateLimiterMode,\n} from \"../types\";\nimport { supabase_service } from \"../services/supabase\";\nimport { withAuth } from \"../lib/withAuth\";\nimport { RateLimiterRedis } from \"rate-limiter-flexible\";\nimport { sendNotification } from \"../services/notification/email_notification\";\nimport { logger } from \"../lib/logger\";\nimport { redlock } from \"../services/redlock\";\nimport { deleteKey, getValue } from \"../services/redis\";\nimport { setValue } from \"../services/redis\";\nimport { validate } from \"uuid\";\nimport * as Sentry from \"@sentry/node\";\nimport { AuthCreditUsageChunk } from \"./v1/types\";\n// const { data, error } = await supabase_service\n//     .from('api_keys')\n//     .select(`\n//       key,\n//       team_id,\n//       teams (\n//         subscriptions (\n//           price_id\n//         )\n//       )\n//     `)\n//     .eq('key', normalizedApi)\n//     .limit(1)\n//     .single();\nfunction normalizedApiIsUuid(potentialUuid: string): boolean {\n  // Check if the string is a valid UUID\n  return validate(potentialUuid);\n}\n\nexport async function setCachedACUC(\n  api_key: string,\n  acuc:\n    | AuthCreditUsageChunk | null\n    | ((acuc: AuthCreditUsageChunk) => AuthCreditUsageChunk | null)\n) {\n  const cacheKeyACUC = `acuc_${api_key}`;\n  const redLockKey = `lock_${cacheKeyACUC}`;\n\n  try {\n    await redlock.using([redLockKey], 10000, {}, async (signal) => {\n      if (typeof acuc === \"function\") {\n        acuc = acuc(JSON.parse(await getValue(cacheKeyACUC) ?? \"null\"));\n\n        if (acuc === null) {\n          if (signal.aborted) {\n            throw signal.error;\n          }\n\n          return;\n        }\n      }\n\n      if (signal.aborted) {\n        throw signal.error;\n      }\n\n      // Cache for 10 minutes. This means that changing subscription tier could have\n      // a maximum of 10 minutes of a delay. - mogery\n      await setValue(cacheKeyACUC, JSON.stringify(acuc), 600, true);\n    });\n  } catch (error) {\n    logger.error(`Error updating cached ACUC ${cacheKeyACUC}: ${error}`);\n  }\n}\n\nexport async function getACUC(\n  api_key: string,\n  cacheOnly = false,\n  useCache = true\n): Promise<AuthCreditUsageChunk | null> {\n  const cacheKeyACUC = `acuc_${api_key}`;\n\n  if (useCache) {\n    const cachedACUC = await getValue(cacheKeyACUC);\n    if (cachedACUC !== null) {\n      return JSON.parse(cachedACUC);\n    }\n  }\n\n  if (!cacheOnly) {\n    let data;\n    let error;\n    let retries = 0;\n    const maxRetries = 5;\n\n    while (retries < maxRetries) {\n      ({ data, error } = await supabase_service.rpc(\n        \"auth_credit_usage_chunk_test_21_credit_pack\",\n        { input_key: api_key }\n      ));\n\n      if (!error) {\n        break;\n      }\n\n      logger.warn(\n        `Failed to retrieve authentication and credit usage data after ${retries}, trying again...`\n      );\n      retries++;\n      if (retries === maxRetries) {\n        throw new Error(\n          \"Failed to retrieve authentication and credit usage data after 3 attempts: \" +\n            JSON.stringify(error)\n        );\n      }\n\n      // Wait for a short time before retrying\n      await new Promise((resolve) => setTimeout(resolve, 200));\n    }\n\n    const chunk: AuthCreditUsageChunk | null =\n      data.length === 0 ? null : data[0].team_id === null ? null : data[0];\n\n    // NOTE: Should we cache null chunks? - mogery\n    if (chunk !== null && useCache) {\n      setCachedACUC(api_key, chunk);\n    }\n    \n    // console.log(chunk);\n\n    return chunk;\n  } else {\n    return null;\n  }\n}\n\nexport async function clearACUC(\n  api_key: string,\n): Promise<void> {\n  const cacheKeyACUC = `acuc_${api_key}`;\n  await deleteKey(cacheKeyACUC);\n}\n\nexport async function authenticateUser(\n  req,\n  res,\n  mode?: RateLimiterMode\n): Promise<AuthResponse> {\n  return withAuth(supaAuthenticateUser, { success: true, chunk: null, team_id: \"bypass\" })(req, res, mode);\n}\n\nexport async function supaAuthenticateUser(\n  req,\n  res,\n  mode?: RateLimiterMode\n): Promise<AuthResponse> {\n  const authHeader =\n    req.headers.authorization ??\n    (req.headers[\"sec-websocket-protocol\"]\n      ? `Bearer ${req.headers[\"sec-websocket-protocol\"]}`\n      : null);\n  if (!authHeader) {\n    return { success: false, error: \"Unauthorized\", status: 401 };\n  }\n  const token = authHeader.split(\" \")[1]; // Extract the token from \"Bearer <token>\"\n  if (!token) {\n    return {\n      success: false,\n      error: \"Unauthorized: Token missing\",\n      status: 401,\n    };\n  }\n\n  const incomingIP = (req.headers[\"x-forwarded-for\"] ||\n    req.socket.remoteAddress) as string;\n  const iptoken = incomingIP + token;\n\n  let rateLimiter: RateLimiterRedis;\n  let subscriptionData: { team_id: string; plan: string } | null = null;\n  let normalizedApi: string;\n\n  let teamId: string | null = null;\n  let priceId: string | null = null;\n  let chunk: AuthCreditUsageChunk | null = null;\n\n  if (token == \"this_is_just_a_preview_token\") {\n    if (mode == RateLimiterMode.CrawlStatus) {\n      rateLimiter = getRateLimiter(RateLimiterMode.CrawlStatus, token);\n    } else {\n      rateLimiter = getRateLimiter(RateLimiterMode.Preview, token);\n    }\n    teamId = \"preview\";\n  } else {\n    normalizedApi = parseApi(token);\n    if (!normalizedApiIsUuid(normalizedApi)) {\n      return {\n        success: false,\n        error: \"Unauthorized: Invalid token\",\n        status: 401,\n      };\n    }\n\n    chunk = await getACUC(normalizedApi);\n\n    if (chunk === null) {\n      return {\n        success: false,\n        error: \"Unauthorized: Invalid token\",\n        status: 401,\n      };\n    }\n\n    teamId = chunk.team_id;\n    priceId = chunk.price_id;\n\n    const plan = getPlanByPriceId(priceId);\n    subscriptionData = {\n      team_id: teamId,\n      plan,\n    };\n    switch (mode) {\n      case RateLimiterMode.Crawl:\n        rateLimiter = getRateLimiter(\n          RateLimiterMode.Crawl,\n          token,\n          subscriptionData.plan\n        );\n        break;\n      case RateLimiterMode.Scrape:\n        rateLimiter = getRateLimiter(\n          RateLimiterMode.Scrape,\n          token,\n          subscriptionData.plan,\n          teamId\n        );\n        break;\n      case RateLimiterMode.Search:\n        rateLimiter = getRateLimiter(\n          RateLimiterMode.Search,\n          token,\n          subscriptionData.plan\n        );\n        break;\n      case RateLimiterMode.Map:\n        rateLimiter = getRateLimiter(\n          RateLimiterMode.Map,\n          token,\n          subscriptionData.plan\n        );\n        break;\n      case RateLimiterMode.CrawlStatus:\n        rateLimiter = getRateLimiter(RateLimiterMode.CrawlStatus, token);\n        break;\n\n      case RateLimiterMode.Preview:\n        rateLimiter = getRateLimiter(RateLimiterMode.Preview, token);\n        break;\n      default:\n        rateLimiter = getRateLimiter(RateLimiterMode.Crawl, token);\n        break;\n      // case RateLimiterMode.Search:\n      //   rateLimiter = await searchRateLimiter(RateLimiterMode.Search, token);\n      //   break;\n    }\n  }\n\n  const team_endpoint_token =\n    token === \"this_is_just_a_preview_token\" ? iptoken : teamId;\n\n  try {\n    await rateLimiter.consume(team_endpoint_token);\n  } catch (rateLimiterRes) {\n    logger.error(`Rate limit exceeded: ${rateLimiterRes}`);\n    const secs = Math.round(rateLimiterRes.msBeforeNext / 1000) || 1;\n    const retryDate = new Date(Date.now() + rateLimiterRes.msBeforeNext);\n\n    // We can only send a rate limit email every 7 days, send notification already has the date in between checking\n    const startDate = new Date();\n    const endDate = new Date();\n    endDate.setDate(endDate.getDate() + 7);\n\n    // await sendNotification(team_id, NotificationType.RATE_LIMIT_REACHED, startDate.toISOString(), endDate.toISOString());\n\n    return {\n      success: false,\n      error: `Rate limit exceeded. Consumed (req/min): ${rateLimiterRes.consumedPoints}, Remaining (req/min): ${rateLimiterRes.remainingPoints}. Upgrade your plan at https://firecrawl.dev/pricing for increased rate limits or please retry after ${secs}s, resets at ${retryDate}`,\n      status: 429,\n    };\n  }\n\n  if (\n    token === \"this_is_just_a_preview_token\" &&\n    (mode === RateLimiterMode.Scrape ||\n      mode === RateLimiterMode.Preview ||\n      mode === RateLimiterMode.Map ||\n      mode === RateLimiterMode.Crawl ||\n      mode === RateLimiterMode.CrawlStatus ||\n      mode === RateLimiterMode.Search)\n  ) {\n    return { success: true, team_id: \"preview\", chunk: null };\n    // check the origin of the request and make sure its from firecrawl.dev\n    // const origin = req.headers.origin;\n    // if (origin && origin.includes(\"firecrawl.dev\")){\n    //   return { success: true, team_id: \"preview\" };\n    // }\n    // if(process.env.ENV !== \"production\") {\n    //   return { success: true, team_id: \"preview\" };\n    // }\n\n    // return { success: false, error: \"Unauthorized: Invalid token\", status: 401 };\n  }\n\n  return {\n    success: true,\n    team_id: teamId ?? undefined,\n    plan: (subscriptionData?.plan ?? \"\") as PlanType,\n    chunk,\n  };\n}\nfunction getPlanByPriceId(price_id: string | null): PlanType {\n  switch (price_id) {\n    case process.env.STRIPE_PRICE_ID_STARTER:\n      return \"starter\";\n    case process.env.STRIPE_PRICE_ID_STANDARD:\n      return \"standard\";\n    case process.env.STRIPE_PRICE_ID_SCALE:\n      return \"scale\";\n    case process.env.STRIPE_PRICE_ID_HOBBY:\n    case process.env.STRIPE_PRICE_ID_HOBBY_YEARLY:\n      return \"hobby\";\n    case process.env.STRIPE_PRICE_ID_STANDARD_NEW:\n    case process.env.STRIPE_PRICE_ID_STANDARD_NEW_YEARLY:\n      return \"standardnew\";\n    case process.env.STRIPE_PRICE_ID_GROWTH:\n    case process.env.STRIPE_PRICE_ID_GROWTH_YEARLY:\n    case process.env.STRIPE_PRICE_ID_SCALE_2M:\n      return \"growth\";\n    case process.env.STRIPE_PRICE_ID_GROWTH_DOUBLE_MONTHLY:\n      return \"growthdouble\";\n    case process.env.STRIPE_PRICE_ID_ETIER2C:\n      return \"etier2c\";\n    case process.env.STRIPE_PRICE_ID_ETIER1A_MONTHLY: //ocqh\n      return \"etier1a\";\n    default:\n      return \"free\";\n  }\n}\n"]}